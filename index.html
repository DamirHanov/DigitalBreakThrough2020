<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evair</title>
    <script src="https://rtcmulticonnection.herokuapp.com/dist/RTCMultiConnection.min.js"></script>
    <script src="https://rtcmulticonnection.herokuapp.com/socket.io/socket.io.js"></script>
    <script src="audio-context.js"></script>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div id='debug'>Debug</div>
    <button id="DecorAddButton"></button>
    <div id="decorations">
        <div id="fireplace" class="decor">
            <img src="./images/fireplace.png">
        </div>
        <div id="cat" class="decor">
            <img src="./images/cat.jpeg">
        </div>
    </div>
    <script src="./decor.js"></script>
    <script>
        var connection = new RTCMultiConnection();
        connection.socketURL = 'https://rtcmulticonnection.herokuapp.com:443/';
        connection.session = {
            audio: true,
            video: true,
            data: true
        };

        connection.onstream = function (event) {
            var video = event.mediaElement;
            video.removeAttribute('volume');
            video.removeAttribute('controls');
            var personDiv = document.createElement('div');
            personDiv.id = event.userid;
            personDiv.className = 'person';
            personDiv.appendChild(video);
            document.body.appendChild(personDiv);

            initAudioContext(event.stream, volume => onVolumeChange(event.userid, volume));
            
            if (event.userid == connection.userid) {
                var myPerson = document.getElementById(connection.userid);
                myPerson.style.zIndex = 10;
                myPerson.style.cursor = 'move';
                dragElement(myPerson);
            }
        };

        connection.onmessage = function(event) {
            var sender = event.userid;
            var senderFullName = event.extra.fullName;

            
            var myPerson = document.getElementById(connection.userid);
            var debug = document.getElementById('debug');
            debug.innerText = 'Пользователи2: ' + document.getElementsByClassName('person').length + '\n';

            if (event.userid != connection.userid) {
                var person = document.getElementById(event.data.id);
                person.style.top = event.data.top;
                person.style.left = event.data.left;

                var maxDist = 1000.0;
                var minDist = 0.0;
                var maxVolume = 1.0;
                var minVolume = 0.0;

                var dist = distanceBetweenElems(myPerson, person);
                var newDist = dist;
                if (newDist > maxDist) {
                    newDist = maxDist;
                }

                var volume = minVolume + (newDist - minDist) * (maxVolume - minVolume) / (maxDist - minDist);
                volume = 1.0 - volume;
                person.firstChild.volume = volume;

                debug.innerText += person.id + ' : ' + dist + ' : ' + volume + '\n';
            }
        };

        function distanceBetweenElems(elem1, elem2) {
            var e1Rect = elem1.getBoundingClientRect();
            var e2Rect = elem2.getBoundingClientRect();
            var dx = (e1Rect.left+(e1Rect.right-e1Rect.left)/2) - (e2Rect.left+(e2Rect.right-e2Rect.left)/2);
            var dy = (e1Rect.top+(e1Rect.bottom-e1Rect.top)/2) - (e2Rect.top+(e2Rect.bottom-e2Rect.top)/2);
            var dist = Math.sqrt(dx * dx + dy * dy);
            return dist;
        }

        function onVolumeChange(user, volume) {
            var personDiv = document.getElementById(user);

            if (volume > 7) {
                personDiv.classList.add('speaking')
            } else {
                personDiv.classList.remove('speaking')
            }
        };

        connection.onleave = function(event) {
            var person = document.getElementById(event.userid);
            person.remove();
        };

        function dragElement(elmnt) {
            var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            elmnt.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();

                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;

                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                
                connection.send({
                    id: elmnt.id,
                    top: elmnt.style.top,
                    left: elmnt.style.left
                });



                var myPerson = document.getElementById(connection.userid);
                var debug = document.getElementById('debug');
                var persons = document.getElementsByClassName('person');
                debug.innerText = 'Пользователи: ' + persons.length + '\n';
                Array.from(persons).forEach(person => {
                    if (person.id != connection.userid) {
                        var maxDist = 1000.0;
                        var minDist = 0.0;
                        var maxVolume = 1.0;
                        var minVolume = 0.0;

                        var dist = distanceBetweenElems(myPerson, person);
                        var newDist = dist;
                        if (newDist > maxDist) {
                            newDist = maxDist;
                        }

                        var volume = minVolume + (newDist - minDist) * (maxVolume - minVolume) / (maxDist - minDist);
                        volume = 1.0 - volume;
                        person.firstChild.volume = volume;

                        debug.innerText += person.id + ' : ' + dist + ' : ' + volume + '\n';
                    }
                });
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        modifiedDragDrop(document.getElementById("fireplace"));
        modifiedDragDrop(document.getElementById("cat"));
        connection.openOrJoin('asdo8yohjn,amfs');
    </script>
    
</body>
</html>