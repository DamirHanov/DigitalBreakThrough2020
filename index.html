<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evair</title>
    <script src="https://rtcmulticonnection.herokuapp.com/dist/RTCMultiConnection.min.js"></script>
    <script src="https://rtcmulticonnection.herokuapp.com/socket.io/socket.io.js"></script>
    <script src="audio-context.js"></script>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <script>
        var connection = new RTCMultiConnection();
        connection.socketURL = 'https://rtcmulticonnection.herokuapp.com:443/';
        connection.session = {
            audio: true,
            video: true,
            data: true
        };

        connection.onstream = function (event) {
            var video = event.mediaElement;
            video.removeAttribute('controls');
            var personDiv = document.createElement('div');
            personDiv.id = event.userid;
            personDiv.className = 'person';
            personDiv.appendChild(video);
            document.body.appendChild(personDiv);

            if (event.userid == connection.userid) {
                var myPerson = document.getElementById(connection.userid);
                myPerson.style.zIndex = 10;
                myPerson.style.cursor = 'move';
                dragElement(myPerson);
            }

            initAudioContext(event.stream, volume => onVolumeChange(event.userid, volume));
        };


        connection.onmessage = function(event) {
            var sender = event.userid;
            var senderFullName = event.extra.fullName;

            var person = document.getElementById(event.data.id);
            person.style.top = event.data.top;
            person.style.left = event.data.left;
        };

        function onVolumeChange(user, volume) {
            var personDiv = document.getElementById(user);

            if (volume > 7) {
                personDiv.classList.add('speaking')
            } else {
                personDiv.classList.remove('speaking')
            }
        };

        connection.onleave = function(event) {
            var person = document.getElementById(event.userid);
            person.remove();
        };

        function dragElement(elmnt) {
            var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            elmnt.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();

                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;

                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                
                connection.send({
                    id: elmnt.id,
                    top: elmnt.style.top,
                    left: elmnt.style.left
                });
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }


        connection.openOrJoin('asdo8yohjn,amfs');
    </script>
</body>
</html>